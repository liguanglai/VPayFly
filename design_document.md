# 虚拟商品贩卖网站设计文档

## 1. 需求概述

我们要构建一个贩卖虚拟商品的网站。商品主要是百度云、夸克云等网盘链接。用户在购买商品后，提供邮箱地址，系统会自动将商品链接发送到该邮箱。

### 核心功能点:
1.  **商品展示**: 用户可以浏览所有在售的虚拟商品。
2.  **在线支付**: 支持微信、支付宝、Wise 和 Apple Pay。
3.  **自动发货**: 付款成功后，系统自动将商品链接发送到用户指定的电子邮箱。
4.  **管理后台**: 管理员可以对商品进行管理，包括上架、下架、编辑和添加新商品。

### 技术选型:
*   **前端**: 未明确指定，但管理后台部分要求使用 Ant Design，因此推荐整体使用 React 框架。
*   **后端**: 使用 Rust 语言实现 Web 服务。
*   **UI库**: Ant Design (主要用于管理后台)。

---

## 2. 基本设计

### 2.1. 用户流程

1.  **访客/买家**:
    *   进入网站，浏览商品列表。
    *   点击某个商品，查看详情。
    *   点击“购买”按钮。
    *   在结账页面填写自己的电子邮箱。
    *   选择支付方式（微信/支付宝/Wise/Apple Pay）并完成支付。
    *   支付成功后，收到包含商品链接的电子邮件。

2.  **管理员**:
    *   访问管理后台登录页面。
    *   输入用户名和密码登录。
    *   进入后台主界面，看到所有商品的列表。
    *   可以对商品进行“上架”、“下架”、“编辑”或“删除”操作。
    *   可以“新增”商品，填写商品名称、价格、描述和最重要的——虚拟商品链接。

### 2.2. 系统模块

1.  **前端应用 (React SPA)**
    *   **商品展示模块**: 负责商品的陈列和详情展示。
    *   **支付流程模块**: 引导用户完成邮箱填写和支付选择。
    *   **管理后台模块**: 提供给管理员的独立操作界面，使用 Ant Design 组件构建。

2.  **后端服务 (Rust API)**
    *   **商品API**: 提供商品的查询接口。
    *   **订单与支付API**: 创建订单，并与各个支付网关（支付宝、微信等）进行交互。
    *   **邮件服务API**: 调用第三方邮件服务（如 SendGrid, Mailgun）来发送商品链接。
    *   **后台管理API**: 提供商品增删改查、管理员登录等后台权限接口。

---

## 3. 详细设计

### 3.1. 数据库表结构设计 (以 PostgreSQL 为例)

**`products` (商品表)**
| 字段名 | 类型 | 描述 |
| :--- | :--- | :--- |
| `id` | UUID | 主键, 唯一标识 |
| `name` | TEXT | 商品名称 |
| `description` | TEXT | 商品描述 |
| `price` | DECIMAL | 价格 |
| `currency` | TEXT | 货币单位 (如 'CNY', 'USD') |
| `link` | TEXT | **核心：虚拟商品链接** |
| `is_published`| BOOLEAN | 是否上架 (true: 上架, false: 下架) |
| `created_at` | TIMESTAMPTZ | 创建时间 |
| `updated_at` | TIMESTAMPTZ | 更新时间 |

**`orders` (订单表)**
| 字段名 | 类型 | 描述 |
| :--- | :--- | :--- |
| `id` | UUID | 主键, 唯一标识 |
| `product_id` | UUID | 关联的商品ID (外键) |
| `customer_email`| TEXT | 顾客邮箱 |
| `status` | TEXT | 订单状态 ('pending', 'completed', 'failed') |
| `payment_gateway`| TEXT | 支付网关 ('alipay', 'wechat_pay', etc.) |
| `payment_id` | TEXT | 支付网关返回的交易号 |
| `created_at` | TIMESTAMPTZ | 创建时间 |
| `updated_at` | TIMESTAMPTZ | 更新时间 |

### 3.2. 后端 API 端点设计 (Rust - Actix-web/Axum)

**公开接口 (Public API):**
*   `GET /api/products`: 获取所有已上架的商品列表。
*   `GET /api/products/:id`: 获取单个商品的详细信息（不包含`link`字段）。
*   `POST /api/orders`: 创建一个新订单。请求体包含 `product_id` 和 `customer_email`。此接口会返回支付所需的信息（如支付二维码链接或跳转URL）。
*   `POST /api/webhooks/payment`: 支付回调接口。用于接收来自支付网关的异步通知，以确认支付状态。

**管理接口 (Admin API - 需要JWT认证):**
*   `POST /api/admin/login`: 管理员登录。
*   `GET /api/admin/products`: 获取所有商品（包括未上架的）。
*   `POST /api/admin/products`: 新增一个商品。
*   `PUT /api/admin/products/:id`: 更新一个已存在的商品。
*   `DELETE /api/admin/products/:id`: 删除一个商品。

### 3.3. 支付流程设计

支付流程是本项目的难点，尤其是多渠道支付。

1.  **用户下单**: 前端将 `product_id` 和 `customer_email` 发送到后端 `/api/orders`。
2.  **后端创建订单**: 后端在 `orders` 表中创建一条状态为 `pending` 的记录。
3.  **调用支付网关**: 后端根据用户选择的支付方式，调用相应支付服务商的SDK，生成支付凭证（如支付宝的支付页面URL或微信的二维码）。
4.  **前端展示凭证**: 后端将支付凭证返回给前端，前端向用户展示（跳转到支付页或显示二维码）。
5.  **用户支付**: 用户完成支付。
6.  **接收回调**: 支付网关异步通知后端的 `/api/webhooks/payment` 接口。
7.  **处理回调**: 后端验证回调请求的合法性，如果支付成功，则：
    *   将 `orders` 表中对应订单的 `status` 更新为 `completed`。
    *   从 `products` 表中查询到商品链接。
    *   调用邮件服务，将链接发送到 `customer_email`。
    *   如果支付失败，则更新状态为 `failed`。

---

## 4. 架构图

这是一个简化的系统架构图，描述了各个组件之间的交互关系。

```
+-----------------+      +-----------------+      +--------------------+
|                 |      |                 |      |                    |
|   用户浏览器     |----->|   React 前端应用 |<---->|   Rust 后端 API     |
| (买家/管理员)   |      | (Ant Design UI) |      | (Actix-web/Axum)   |
|                 |      |                 |      |                    |
+-----------------+      +-------+---------+      +----------+---------+
                                 |                           |
                                 |                           |
            +--------------------+---------------------------+
            |                    |                           |
            |                    |                           |
+-----------v-----------+   +----v----+   +------------------v---+   +------------------v---+
|                       |   |         |   |                      |   |                      |
|  支付宝/微信/Wise/AP   |   | 数据库  |   |   第三方邮件服务      |   |   (可选)对象存储      |
|      (支付网关)        |   | (PostgreSQL)|   |   (e.g., SendGrid)   |   |   (e.g., 七牛云)      |
+-----------------------+   +---------+   +----------------------+   +----------------------+

```

### 架构说明:
1.  **用户浏览器**: 最终用户（买家或管理员）的访问入口。
2.  **React 前端应用**: 一个单页应用（SPA），负责所有UI渲染和用户交互。管理员界面会重度使用 Ant Design 组件。
3.  **Rust 后端 API**: 核心业务逻辑层。处理来自前端的请求，操作数据库，并与所有外部服务（支付、邮件）通信。
4.  **支付网关**: 处理实际的支付流程。后端需要与它们进行集成。
5.  **数据库**: 持久化存储商品和订单数据。
6.  **第三方邮件服务**: 负责在支付成功后自动发送邮件。
7.  **对象存储 (可选)**: 如果未来商品本身是文件而不是链接，可以直接将文件存储在七牛云等服务，然后将私有访问链接发送给用户。
